FROM ruby:2.6.2-alpine

ENV RAILS_ENV production
RUN apk upgrade --no-cache && \
  apk add --update --no-cache \
  sqlite-dev \
  bash \
  git \
  nodejs \
  nodejs-npm \
  ttf-freefont \
  tzdata
  # && \
  # apk add --update --no-cache --virtual=build-dependencies \
  # build-base \
  # curl-dev \
  # linux-headers \
  # libxml2-dev \
  # libxslt-dev \
  # postgresql-dev \
  # ruby-dev \
  # yaml-dev \
  # zlib-dev

# dockerのキャッシュ戦略によって、下記のコードでは毎回cloneされないため、--no-cacheを利用する
RUN git clone --depth 1 --branch master https://github.com/nnh/k8s-sandbox.git app
WORKDIR /app

RUN  gem install bundler && \
  bundle install --without development test && \
  npm install -g yarn && \
  yarn install --production=true && \
  bundle exec rake assets:precompile

